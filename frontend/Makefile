# Makefile for OnPrem TechPrimer Docker deployment
# Provides cross-platform commands for building and managing the application

.PHONY: help build run stop clean logs dev prod test health

# Default target
help:
	@echo "ðŸš€ OnPrem TechPrimer Docker Management"
	@echo "====================================="
	@echo ""
	@echo "Available commands:"
	@echo "  build     - Build Docker image"
	@echo "  run       - Build and run container"
	@echo "  stop      - Stop and remove container"
	@echo "  clean     - Clean up containers and images"
	@echo "  logs      - View container logs"
	@echo "  dev       - Run in development mode"
	@echo "  prod      - Run in production mode"
	@echo "  test      - Run health checks"
	@echo "  health    - Check application health"
	@echo "  help      - Show this help message"
	@echo ""

# Configuration
IMAGE_NAME = onprem-techprimer
CONTAINER_NAME = onprem-techprimer-frontend
TAG ?= latest

# Build the Docker image
build:
	@echo "ðŸ”¨ Building Docker image..."
	docker build --target production -t $(IMAGE_NAME):$(TAG) -t $(IMAGE_NAME):latest .
	@echo "âœ… Build completed successfully"

# Run the container
run: build
	@echo "ðŸš€ Starting container..."
	@docker stop $(CONTAINER_NAME) 2>/dev/null || true
	@docker rm $(CONTAINER_NAME) 2>/dev/null || true
	docker run -d \
		--name $(CONTAINER_NAME) \
		-p 80:80 \
		-p 443:443 \
		-e NODE_ENV=production \
		-e ENVIRONMENT=production \
		--restart unless-stopped \
		$(IMAGE_NAME):$(TAG)
	@echo "âœ… Container started successfully"
	@echo "ðŸŒ Application available at:"
	@echo "   HTTP:  http://localhost"
	@echo "   HTTPS: https://localhost"

# Stop and remove container
stop:
	@echo "ðŸ›‘ Stopping container..."
	@docker stop $(CONTAINER_NAME) 2>/dev/null || echo "Container not running"
	@docker rm $(CONTAINER_NAME) 2>/dev/null || echo "Container not found"
	@echo "âœ… Container stopped and removed"

# Clean up containers and images
clean: stop
	@echo "ðŸ§¹ Cleaning up Docker resources..."
	@docker rmi $(IMAGE_NAME):$(TAG) 2>/dev/null || echo "Image not found"
	@docker rmi $(IMAGE_NAME):latest 2>/dev/null || echo "Latest image not found"
	@docker system prune -f
	@echo "âœ… Cleanup completed"

# View container logs
logs:
	@echo "ðŸ“‹ Container logs:"
	@docker logs $(CONTAINER_NAME) --tail 50 -f

# Run in development mode
dev:
	@echo "ðŸ”§ Starting in development mode..."
	@docker stop $(CONTAINER_NAME)-dev 2>/dev/null || true
	@docker rm $(CONTAINER_NAME)-dev 2>/dev/null || true
	docker run -d \
		--name $(CONTAINER_NAME)-dev \
		-p 3000:80 \
		-e NODE_ENV=development \
		-e ENVIRONMENT=dev \
		$(IMAGE_NAME):$(TAG)
	@echo "âœ… Development container started"
	@echo "ðŸŒ Available at: http://localhost:3000"

# Run in production mode
prod: run
	@echo "ðŸ­ Production mode activated"

# Run health checks
test:
	@echo "ðŸ§ª Running health checks..."
	@docker ps | grep $(CONTAINER_NAME) || (echo "âŒ Container not running" && exit 1)
	@curl -f http://localhost/health >/dev/null 2>&1 || (echo "âŒ Health check failed" && exit 1)
	@echo "âœ… All health checks passed"

# Check application health
health:
	@echo "ðŸ¥ Application health status:"
	@docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep $(CONTAINER_NAME) || echo "âŒ Container not running"
	@echo ""
	@echo "Health endpoint:"
	@curl -s http://localhost/health || echo "âŒ Health endpoint not responding"

# Quick start (build and run)
start: run

# Restart container
restart:
	@echo "ðŸ”„ Restarting container..."
	@docker restart $(CONTAINER_NAME) 2>/dev/null || echo "Container not found"
	@echo "âœ… Container restarted"

# Show container status
status:
	@echo "ðŸ“Š Container status:"
	@docker ps -a --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep $(CONTAINER_NAME) || echo "No containers found"

# Show container resources
resources:
	@echo "ðŸ’¾ Container resource usage:"
	@docker stats $(CONTAINER_NAME) --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.NetIO}}\t{{.BlockIO}}" 2>/dev/null || echo "Container not running"

# Backup SSL certificates
backup-certs:
	@echo "ðŸ’¾ Backing up SSL certificates..."
	@docker cp $(CONTAINER_NAME):/etc/nginx/ssl ./ssl-backup 2>/dev/null || echo "No certificates to backup"
	@echo "âœ… Certificates backed up to ./ssl-backup"

# Restore SSL certificates
restore-certs:
	@echo "ðŸ“¥ Restoring SSL certificates..."
	@docker cp ./ssl-backup $(CONTAINER_NAME):/etc/nginx/ssl 2>/dev/null || echo "No backup found"
	@docker restart $(CONTAINER_NAME) 2>/dev/null || echo "Container not running"
	@echo "âœ… Certificates restored"

# Show Nginx configuration
show-config:
	@echo "âš™ï¸ Nginx configuration:"
	@docker exec $(CONTAINER_NAME) cat /etc/nginx/nginx.conf 2>/dev/null || echo "Container not running"

# Show Nginx logs
nginx-logs:
	@echo "ðŸ“‹ Nginx access logs:"
	@docker exec $(CONTAINER_NAME) tail -20 /var/log/nginx/access.log 2>/dev/null || echo "Container not running"
	@echo ""
	@echo "ðŸ“‹ Nginx error logs:"
	@docker exec $(CONTAINER_NAME) tail -20 /var/log/nginx/error.log 2>/dev/null || echo "Container not running"
